---
title: "Sardine MSE Result Notes"
author: "Robert Wildermuth"
date: "7/26/2021"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(r4ss)
library(ss3sim)
library(hablar) # just so I can convert a column data type
source("plot_comp_sampling.R")
source("plot_index_sampling.R")
```

# Evaluation of sardine cohort growth operating model

The following notes document the results of applying a 6 year projection to Peter Kuriyama's cohort growth Stock Synthesis model for Pacific sardine using {SSMSE}. The separate runs progress from a self test to applying additional sampling error in the SSMSE sampling module.

## Self test with only acoustic-trawl index specified

```{r OMselftest}
# read in SSMSE results summary
tsSumry <- read.csv("C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest/results_ts_cohortGrowthselftest.csv")

# Get rid of duplicated SSB years
tsSumry <- na.omit(tsSumry)

# bring in simulated data for each iteration to plot with OM and EM vals
simDat <- data.frame()
for(i in c(2,4:9)){
  itDat <- SS_readdat(file = paste0("C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest/",
                           i, "/cohortGrowthOMandEM_EM_2024/data.ss_new"),
                      version = "3.30")[["CPUE"]] %>%
            filter(index == 4) %>%
            mutate(iteration = i,
                   model_run = "cohortGrowthselftest_data")

  simDat <- rbind(simDat, itDat)
}
  
# simDat <- SS_readdat(file = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest/2/cohortGrowthOMandEM_EM_2024/data.ss_new",
#                       version = "3.30")[["CPUE"]] %>%
#             filter(index == 4) %>%
#             mutate(#iteration = i,
#                    model_run = "cohortGrowthselftest_data")

# plots of simulated and estimated biomass trends per iteration
ggplot2::ggplot(data = subset(tsSumry, model_run %in% c("0_estimate_cohort_growh_OM",  
                                                      "cohortGrowthOMandEM_EM_2020",
                                                      "cohortGrowthOMandEM_EM_2021",
                                                      "cohortGrowthOMandEM_EM_2022",
                                                      "cohortGrowthOMandEM_EM_2023",
                                                      "cohortGrowthOMandEM_EM_2024")), 
                ggplot2::aes(x = year, y = SpawnBio)) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_point(data = simDat, mapping = aes(x = year, y = obs), shape = 4, color = "grey") +
  ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
  ggplot2::scale_color_manual(values = c("#D65F00", rep("black", 4), "blue")) +
  ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
  ggplot2::guides(linetype = FALSE) +
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::theme_classic()

# plot of OM and EM and simulated data
indexPlot <- plot_index_sampling(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest")
# !!RW: sampled_dataset are different among iterations

indexPlot # !RW: only getting last three iterations, but gets the point across 
```

### Summary plots of terminal year estimates
```{r}
termYr <- tsSumry %>% filter(model_run %in% c("0_estimate_cohort_growh_OM", 
                                              "cohortGrowthOMandEM_EM_init") | # or keep end years
                             year == as.numeric(regmatches(model_run, 
                                                           gregexpr("[[:digit:]]+", model_run))))

termYr <- termYr %>% mutate(model_run = as.character(model_run),
                            model_run = case_when(!model_run %in% c("0_estimate_cohort_growh_OM", 
                                                                    "cohortGrowthOMandEM_EM_init") ~"cohortGrowthOMandEM_EM_term",
                                                  TRUE ~ model_run))

ggplot2::ggplot(data = termYr, 
                ggplot2::aes(x = year, y = SpawnBio)) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_point(data = simDat, mapping = aes(x = year, y = obs), shape = 4, color = "grey") +
  ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
  ggplot2::scale_color_manual(values = c("#D65F00", "black", rep("blue", 5))) +
  ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
  ggplot2::guides(linetype = FALSE) +
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::theme_classic()

relSSB_EMtoOM <- termYr %>% select(model_run, year, iteration, SpawnBio) %>%
                    pivot_wider(id_cols = c(year, iteration),
                                names_from = model_run, values_from = SpawnBio) %>%
                    rename(cohort_growth_OM = "0_estimate_cohort_growh_OM") %>%
                    mutate(diffSSB = case_when(is.na(cohortGrowthOMandEM_EM_term) ~ cohortGrowthOMandEM_EM_init - cohort_growth_OM,
                                               !is.na(cohortGrowthOMandEM_EM_term) ~ cohortGrowthOMandEM_EM_term - cohort_growth_OM))

relSSB_EMtoOM <- relSSB_EMtoOM %>% full_join(y = simDat, by = c("year", "iteration")) %>%
                    mutate(diffDat = obs - cohort_growth_OM)

ggplot(data = relSSB_EMtoOM, aes(x = year, y = diffSSB)) +
  ggplot2::geom_vline(xintercept = 2019, color = "gray") +
  geom_hline(yintercept = 0, color = "black") +
  geom_point(mapping = aes(x = year, y = diffDat), shape = 4, color = "grey") +
  ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = 2))+
  #ggplot2::scale_color_manual(values = c("#D65F00", "black", rep("blue", 5))) +
  ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
  ggplot2::guides(linetype = FALSE) +
  ggplot2::facet_wrap(. ~ iteration) +
  ggplot2::theme_classic()
```

### Plots of length and age composition
```{r}
# plot_comp_sampling(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest", comp_type = "agecomp")
# !!!Error: The comp database from the operating model has no rows, so must not have been any historical data in the OM.

outputSS <- SS_output(
  dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest/2/cohortGrowthOMandEM_EM_2024",
  dir.mcmc = NULL,
  repfile = "Report.sso",
  compfile = "CompReport.sso")

SSplotComps(replist = outputSS, kind = "LEN")

SSplotComps(replist = outputSS, kind = "AGE") # nothing happens

# Try using r4ss supporting function
tmp <- SSMethod.TA1.8(fit = outputSS, type = "len", 
                      fleet = 4, fleetnames = outputSS[["FleetNames"]], datonly = FALSE, 
                                  printit = FALSE)
# doesn't show compositions by length

unique(outputSS[["lendbase"]]$Yr) # doesn't have data from projection years (2020-2024)
FleetNames <- outputSS[["FleetNames"]]

# try using ss3sim::get_compfit
# RW: function doesn't exist in the package? but it's in the index...
# get_compfit(report.file = outputSS, name = "len_comp_fit_table")

# run_SSMSE uses expected values for OM catch, so use these in figs
# RW: 'lendbase' only has observed years from historical time series
# termLenComps <- outputSS[["lendbase"]] %>% filter(Fleet == which(FleetNames == "AT_Survey")) %>%
#                   select(Yr, Seas, Fleet, Bin, Exp)

# Plot terminal age and length comps for OM and EM by iteration
termLenComps <- data.frame()
termAgeComps <- data.frame()

for(i in c(2,4:9)){
  outputSS <- SS_output(dir = paste0( "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest/", 
                                     i, "/cohortGrowthOMandEM_EM_2024"),
                        dir.mcmc = NULL,
                        repfile = "Report.sso",
                        compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
  
  EMLenComps <- outputSS[["batlen"]] %>% filter(Yr == 2024, Seas == 2, `Beg/Mid` == "B") %>%
                  pivot_longer(cols = c("6", "6.5", "7", "7.5", "8", "8.5", "9", "9.5", "10", "10.5", 
                                        "11", "11.5", "12", "12.5", "13", "13.5", "14", "14.5", "15", "15.5",
                                        "16", "16.5", "17", "17.5", "18", "18.5", "19", "19.5", "20", "20.5",
                                        "21", "21.5", "22", "22.5", "23", "23.5", "24", "24.5", "25", "25.5", 
                                        "26", "26.5", "27", "27.5", "28", "28.5", "29", "29.5", "30"),
                               names_to = "Bin", values_to = "Biomass") %>%
                  mutate(Bin = as.numeric(Bin),
                         model_run = "cohortGrowthOMandEM_EM_2024",
                         iteration = i)

  EMAgeComps <- outputSS[["batage"]] %>% filter(Yr == 2024, Seas == 2, `Beg/Mid` == "B") %>%
                  pivot_longer(cols = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"),
                               names_to = "Age", values_to = "Biomass") %>%
                  mutate(Age = as.numeric(Age),
                         model_run = "cohortGrowthOMandEM_EM_2024",
                         iteration = i)
  
  OMoutputSS <- SS_output(dir = paste0( "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest/", 
                                       i, "/0_estimate_cohort_growh_OM"),
                          dir.mcmc = NULL,
                          repfile = "Report.sso",
                          compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)

  OMLenComps <- OMoutputSS[["batlen"]] %>% filter(Yr == 2024, Seas == 2, `Beg/Mid` == "B") %>%
                  pivot_longer(cols = c("6", "6.5", "7", "7.5", "8", "8.5", "9", "9.5", "10", "10.5", 
                                        "11", "11.5", "12", "12.5", "13", "13.5", "14", "14.5", "15", "15.5",
                                        "16", "16.5", "17", "17.5", "18", "18.5", "19", "19.5", "20", "20.5",
                                        "21", "21.5", "22", "22.5", "23", "23.5", "24", "24.5", "25", "25.5", 
                                        "26", "26.5", "27", "27.5", "28", "28.5", "29", "29.5", "30"),
                               names_to = "Bin", values_to = "Biomass") %>%
                  mutate(Bin = as.numeric(Bin),
                         model_run = "0_estimate_cohort_growh_OM",
                         iteration = i)
  OMAgeComps <- OMoutputSS[["batage"]] %>% filter(Yr == 2024, Seas == 2, `Beg/Mid` == "B") %>%
                  pivot_longer(cols = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"),
                               names_to = "Age", values_to = "Biomass") %>%
                  mutate(Age = as.numeric(Age),
                         model_run = "0_estimate_cohort_growh_OM",
                         iteration = i)
  termAgeComps <- rbind(termAgeComps, EMAgeComps, OMAgeComps)
  termLenComps <- rbind(termLenComps, EMLenComps, OMLenComps)
}

# RW: no composition data for last year because none provided in 'sample_struct_list' for run_SSMSE()
ggplot(termLenComps, mapping = aes(x = Bin, y = Biomass)) +
  geom_col() +
  facet_grid(cols = vars(model_run), rows = vars(iteration))


ggplot(termAgeComps, mapping = aes(x = Age, y = Biomass)) +
  geom_col() +
  facet_grid(cols = vars(model_run), rows = vars(iteration))
```

## Generalized functions applied to Self Test with AT only

Make some generalized functions to apply to different scenarios
```{r BiomDiagnosticPlots}

# Function to plot absolute spawning biomass from OM, simulated data, and EM in and also relative error
# Note: assumes SSMSE_summary_all has been run for a completed scenario
bDiagPlots <- function(dir, # SSMSE directory (character)
                       scenario, # scenario name (character)
                       termYr, # terminal year of MSE run
                       surveyInx # numeric index of the survey fleet for data comparison (e.g., Acoustic-Trawl)
  ){
  

  # read in SSMSE results summary
  tsSumry <- read.csv(file.path(dir, scenario, paste0("results_ts_", scenario, ".csv")))

  # Get rid of duplicated SSB years
  tsSumry <- na.omit(tsSumry)

  # get the iterations
  iters <- list.dirs(file.path(dir, scenario), recursive = FALSE, full.names = FALSE)

  # get the OM, init, and terminal year model directory names
  omName <- grep("_OM", list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)
  initName <- grep("_init", list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)
  termName <- grep(paste0("_", termYr), 
                   list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)
  
  # bring in simulated data for each iteration to plot with OM and EM vals
  simDat <- data.frame()
  for(i in iters){
    itDat <- SS_readdat(file = file.path(dir, scenario, i, termName, "data.ss_new"),
                        version = "3.30")[["CPUE"]] %>%
              filter(index == surveyInx) %>%
              mutate(iteration = i,
                     model_run = paste0(scenario,"_data"))

    simDat <- rbind(simDat, itDat)
    }

  # Find the estimate of the terminal year for each year of the MSE cycle
  termYr <- tsSumry %>% filter(model_run %in% c(omName, initName) | # or keep end years
                               year == as.numeric(regmatches(model_run, 
                                                             gregexpr("[[:digit:]]+", model_run)))) %>% 
              mutate(model_run = as.character(model_run),
                     model_run = case_when(!model_run %in% c(omName, initName) ~ paste0(scenario, "_EM_term"),
                                           TRUE ~ model_run))

  # plot biomass per iteration
  absoluteBio <- ggplot2::ggplot(data = termYr, 
                  ggplot2::aes(x = year, y = SpawnBio)) +
              ggplot2::geom_vline(xintercept = 2019, color = "gray") +
              geom_point(data = simDat, mapping = aes(x = year, y = obs), shape = 4, color = "grey") +
              ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
              ggplot2::scale_color_manual(values = c("#D65F00", "black", rep("blue", 5))) +
              ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
              ggplot2::guides(linetype = FALSE) +
              ggplot2::facet_wrap(. ~ iteration) +
              ggplot2::theme_classic()

  # Calculate SSB relative error
  relSSB_EMtoOM <- termYr %>% select(model_run, year, iteration, SpawnBio) %>%
                      pivot_wider(id_cols = c(year, iteration),
                                  names_from = model_run, values_from = SpawnBio) %>%
                      rename(OM = all_of(omName))
  
  # crazy BS to make a summary column based on conditions in another column
  relSSB_EMtoOM <- relSSB_EMtoOM %>% add_column(diffSSB = unlist(relSSB_EMtoOM[, initName]))
  histInd <- which(!is.na(relSSB_EMtoOM[,paste0(scenario, "_EM_term")]))
  relSSB_EMtoOM[histInd, "diffSSB"] <- relSSB_EMtoOM[histInd, paste0(scenario, "_EM_term")]
  relSSB_EMtoOM <- relSSB_EMtoOM %>% mutate(diffSSB = (diffSSB - OM)/OM)

  # Merge the simulated data with the model estimates
  simDat <- simDat %>% convert(int(iteration))
  relSSB_EMtoOM <- relSSB_EMtoOM %>% full_join(y = simDat, by = c("year", "iteration")) %>%
                      mutate(diffDat = (obs - OM)/OM)

  relBio <- ggplot(data = relSSB_EMtoOM, aes(x = year, y = diffSSB)) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    geom_hline(yintercept = 0, color = "black") +
    geom_point(mapping = aes(x = year, y = diffDat), shape = 4, color = "grey") +
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = 2))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "black", rep("blue", 5))) +
    ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
    ggplot2::guides(linetype = FALSE) +
    ggplot2::facet_wrap(. ~ iteration) +
    ggplot2::theme_classic() +
    ylab("Relative Error (SSB)")
  
  list(absoluteBio, relBio)
}

#test it out
bDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
          scenario = "cohortGrowthselftest",
          termYr = 2024, surveyInx = 4)
```

```{r CompDiagnosticPlots}
# Function to plot length and age composition plots for sardine SS models
compDiagPlots <- function(dir, # SSMSE directory (character)
                          scenario, # scenario name (character)
                          termYr # terminal year of MSE run
  ){

  # get the iterations
  iters <- list.dirs(file.path(dir, scenario), recursive = FALSE, full.names = FALSE)
  
  # # get the OM, init, and terminal year model directory names
  omName <- grep("_OM", list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)
  # initName <- grep("_init", list.dirs(file.path(dir, scenario, iters[1]),
  #                                 recursive = FALSE,
  #                                 full.names = FALSE), value = TRUE)
  termName <- grep(paste0("_", termYr),
                   list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)

  # Extract terminal age and length comps for OM and EM by iteration
  termLenComps <- data.frame()
  termAgeComps <- data.frame()
  for(i in iters){
    outputSS <- SS_output(dir = file.path(dir, scenario, i, termName),
                          dir.mcmc = NULL,
                          repfile = "Report.sso",
                          compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
  
    # Get estimation model's estimated compositions
    EMLenComps <- outputSS[["batlen"]] %>% filter(Yr == termYr, Seas == 2, `Beg/Mid` == "B") %>%
                    pivot_longer(cols = c("6", "6.5", "7", "7.5", "8", "8.5", "9", "9.5", "10", "10.5", 
                                          "11", "11.5", "12", "12.5", "13", "13.5", "14", "14.5", "15", "15.5",
                                          "16", "16.5", "17", "17.5", "18", "18.5", "19", "19.5", "20", "20.5",
                                          "21", "21.5", "22", "22.5", "23", "23.5", "24", "24.5", "25", "25.5", 
                                          "26", "26.5", "27", "27.5", "28", "28.5", "29", "29.5", "30"),
                                 names_to = "Bin", values_to = "Biomass") %>%
                    mutate(Bin = as.numeric(Bin),
                           model_run = termName,
                           iteration = as.integer(i))

    EMAgeComps <- outputSS[["batage"]] %>% filter(Yr == termYr, Seas == 2, `Beg/Mid` == "B") %>%
                    pivot_longer(cols = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"),
                                 names_to = "Age", values_to = "Biomass") %>%
                    mutate(Age = as.numeric(Age),
                           model_run = termName,
                           iteration = as.integer(i))
    
    # get OM compositions
    OMoutputSS <- SS_output(dir = file.path(dir, scenario, i, omName),
                            dir.mcmc = NULL,
                            repfile = "Report.sso",
                            compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
  
    OMLenComps <- OMoutputSS[["batlen"]] %>% filter(Yr == termYr, Seas == 2, `Beg/Mid` == "B") %>%
                    pivot_longer(cols = c("6", "6.5", "7", "7.5", "8", "8.5", "9", "9.5", "10", "10.5", 
                                          "11", "11.5", "12", "12.5", "13", "13.5", "14", "14.5", "15", "15.5",
                                          "16", "16.5", "17", "17.5", "18", "18.5", "19", "19.5", "20", "20.5",
                                          "21", "21.5", "22", "22.5", "23", "23.5", "24", "24.5", "25", "25.5", 
                                          "26", "26.5", "27", "27.5", "28", "28.5", "29", "29.5", "30"),
                                 names_to = "Bin", values_to = "Biomass") %>%
                    mutate(Bin = as.numeric(Bin),
                           model_run = omName,
                           iteration = as.integer(i))
    OMAgeComps <- OMoutputSS[["batage"]] %>% filter(Yr == termYr, Seas == 2, `Beg/Mid` == "B") %>%
                    pivot_longer(cols = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"),
                                 names_to = "Age", values_to = "Biomass") %>%
                    mutate(Age = as.numeric(Age),
                           model_run = omName,
                           iteration = as.integer(i))
    termAgeComps <- rbind(termAgeComps, EMAgeComps, OMAgeComps)
    termLenComps <- rbind(termLenComps, EMLenComps, OMLenComps)
    }

  # Plot the comps by model and iteration
  lenCompPlot <- ggplot(termLenComps, mapping = aes(x = Bin, y = Biomass)) +
                    geom_col() +
                    facet_grid(cols = vars(model_run), rows = vars(iteration))

  ageCompPlot <- ggplot(termAgeComps, mapping = aes(x = Age, y = Biomass)) +
                    geom_col() +
                    facet_grid(cols = vars(model_run), rows = vars(iteration))
  
  list(lenCompPlot, ageCompPlot)
  }

#test it out
compDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthselftest",
              termYr = 2024)
```

```{r RecDiagnosticPlot}
# pull recruitment from summary dq
# Function to plot recruitment from OM and EM 
# Note: assumes SSMSE_summary_all has been run for a completed scenario
recrDiagPlots <- function(dir, # SSMSE directory (character)
                          scenario, # scenario name (character)
                          termYr # terminal year of MSE run
  ){
  # read in SSMSE results summary derived quantaties
  dqSumry <- read.csv(file.path(dir, scenario, paste0("results_dq_", scenario, ".csv")))

  # get the OM, init, and terminal year model directory names
  omName <- grep("_OM", dqSumry$model_run, value = TRUE)[1]
  initName <- grep("_init", dqSumry$model_run, value = TRUE)[1]
  termName <- grep(paste0("_", termYr), dqSumry$model_run, value = TRUE)[1]
  
  # Find the estimate of the terminal year for each year of the MSE cycle
  termYr <- dqSumry %>% select(Value.Recr, year, model_run, iteration) %>%
              filter(model_run %in% c(omName, initName) | # or keep end years
                     year == as.numeric(regmatches(model_run, 
                                        gregexpr("[[:digit:]]+", model_run)))) %>% 
              mutate(model_run = as.character(model_run),
                     model_run = case_when(!model_run %in% c(omName, initName) ~ paste0(scenario, "_EM_term"),
                                           TRUE ~ model_run))
  
  absoluteRec <- ggplot2::ggplot(data = termYr, 
                  ggplot2::aes(x = year, y = Value.Recr)) +
              ggplot2::geom_vline(xintercept = 2019, color = "gray") +
              ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
              ggplot2::scale_color_manual(values = c("#D65F00", "black", "blue")) +
              ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
              ggplot2::guides(linetype = "none") +
              ggplot2::facet_wrap(. ~ iteration) +
              ggplot2::theme_classic()
  
  # Calculate recruitment relative error
  relRec_EMtoOM <- termYr %>% pivot_wider(id_cols = c(year, iteration),
                                          names_from = model_run, values_from = Value.Recr) %>%
                      rename(OM = all_of(omName))
  
  # crazy BS to make a summary column based on conditions in another column
  relRec_EMtoOM <- relRec_EMtoOM %>% add_column(diffRec = unlist(relRec_EMtoOM[, initName]))
  histInd <- which(!is.na(relRec_EMtoOM[,paste0(scenario, "_EM_term")]))
  relRec_EMtoOM[histInd, "diffRec"] <- relRec_EMtoOM[histInd, paste0(scenario, "_EM_term")]
  relRec_EMtoOM <- relRec_EMtoOM %>% mutate(diffRec = (diffRec - OM)/OM)

  relRec <- ggplot(data = relRec_EMtoOM, aes(x = year, y = diffRec)) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    geom_hline(yintercept = 0, color = "black") +
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = 2))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "black", rep("blue", 5))) +
    ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
    ggplot2::guides(linetype = "none") +
    ggplot2::facet_wrap(. ~ iteration) +
    ggplot2::theme_classic() +
    ylab("Relative Error (Recruitment)")
  
  list(absoluteRec, relRec)

  }

recrDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthselftest", termYr = 2024)
```

```{r CatchDiagnosticPlot}
#TotCatch_ in ss_summary.sso? or outputSS[["catch"]]
# outputSS <- SS_output(
#   dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM/cohortGrowthselftest/2/cohortGrowthOMandEM_EM_2024",
#   dir.mcmc = NULL,
#   repfile = "Report.sso",
#   compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
# 
# catSmry <- outputSS[["catch"]] %>% group_by(Yr) %>%
#               # summarize totoal catch within year
#               dplyr::summarize(obsCat = sum(Obs),
#                                expCat = sum(Exp))

# Function to plot OM, simulated data, and EM estimated catch for sardine SS models
catchDiagPlots <- function(dir, # SSMSE directory (character)
                          scenario, # scenario name (character)
                          termYr # terminal year of MSE run
  ){

  # get the iterations
  iters <- list.dirs(file.path(dir, scenario), recursive = FALSE, full.names = FALSE)
  
  # # get the OM, init, and terminal year model directory names
  omName <- grep("_OM", list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)
  # initName <- grep("_init", list.dirs(file.path(dir, scenario, iters[1]),
  #                                 recursive = FALSE,
  #                                 full.names = FALSE), value = TRUE)
  termName <- grep(paste0("_", termYr),
                   list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)

  # Extract terminal age and length comps for OM and EM by iteration
  catch <- data.frame()
  simDat <- data.frame()
  for(i in iters){
    outputSS <- SS_output(dir = file.path(dir, scenario, i, termName),
                          dir.mcmc = NULL,
                          repfile = "Report.sso",
                          compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
  
    # Get EM estimated catch
    catchEM <- outputSS[["catch"]] %>% group_by(Yr) %>%
                  # summarize totoal catch within year
                  dplyr::summarize(obsCat = sum(Obs),
                                   expCat = sum(Exp)) %>%
                  mutate(model_run = termName,
                         iteration = as.integer(i))
      
    # get OM catch
    OMoutputSS <- SS_output(dir = file.path(dir, scenario, i, omName),
                            dir.mcmc = NULL,
                            repfile = "Report.sso",
                            compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
  
    catchOM <- OMoutputSS[["catch"]] %>% group_by(Yr) %>%
                  # summarize totoal catch within year
                  dplyr::summarize(obsCat = sum(Obs),
                                   expCat = sum(Exp)) %>%
                  mutate(model_run = omName,
                         iteration = as.integer(i))
    
    itDat <- SS_readdat(file = file.path(dir, scenario, i, termName, "data.ss_new"),
                        version = "3.30")[["catch"]] %>%
                # summarize totoal catch within year
                group_by(year) %>%
                dplyr::summarize(catch = sum(catch)) %>%
                mutate(iteration = as.integer(i),
                       model_run = paste0(scenario,"_data"))

    catch <- rbind(catch, catchEM, catchOM)
    simDat <- rbind(simDat, itDat)
    } # end 'iter' for-loop
  
  # catch <- catch %>% select(Yr, expCat, model_run, iteration) %>%
  #             rename(year = Yr,
  #                    catch = expCat)
  simDat <- simDat %>% filter(year > 0)
  #catch <- rbind(catch, simDat)

  absoluteCatch <- ggplot2::ggplot(data = catch, 
                  ggplot2::aes(x = Yr, y = expCat)) +
              ggplot2::geom_vline(xintercept = 2019, color = "gray") +
              geom_point(data = simDat, mapping = aes(x = year, y = catch), shape = 4, color = "grey") +
              ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
              ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
              ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
              ggplot2::guides(linetype = FALSE) +
              ggplot2::facet_wrap(. ~ iteration) +
              ggplot2::theme_classic()
  
  # Calculate catch relative error
  relCat_EMtoOM <- catch %>% select(model_run, Yr, iteration, expCat) %>%
                      pivot_wider(id_cols = c(Yr, iteration),
                                  names_from = model_run, values_from = expCat) %>%
                      rename(OM = all_of(omName),
                             EM = all_of(termName)) %>% 
                      mutate(errCat = (EM - OM)/OM)

  # Merge the simulated data with the model estimates
  relCat_EMtoOM <- relCat_EMtoOM %>% full_join(y = simDat, by = c("Yr" = "year", "iteration")) %>%
                      mutate(diffDat = (catch - OM)/OM)

  relCatch <- ggplot(data = relCat_EMtoOM, aes(x = Yr, y = errCat)) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    geom_hline(yintercept = 0, color = "black") +
    geom_point(mapping = aes(x = Yr, y = diffDat), shape = 4, color = "grey") +
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = 2))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "black", rep("blue", 5))) +
    ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
    ggplot2::guides(linetype = "none") +
    ggplot2::facet_wrap(. ~ iteration) +
    ggplot2::theme_classic() +
    ylab("Relative Error (Catch)")
  
  list(absoluteCatch, relCatch)
}

catchDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthselftest", termYr = 2024)
```

The catch errors are minuscule. Using the right outputs?

```{r FmsyDiagnosticPlot}
# pull recruitment from summary scalar
# Function to plot Fmsy from OM and EM 
# Note: assumes SSMSE_summary_all has been run for a completed scenario
FmsyDiagPlots <- function(dir, # SSMSE directory (character)
                          scenario, # scenario name (character)
                          termYr # terminal year of MSE run
  ){
  # read in SSMSE results summary derived quantaties
  sclSumry <- read.csv(file.path(dir, scenario, paste0("results_scalar_", scenario, ".csv")))

  # get the OM, init, and terminal year model directory names
  omName <- grep("_OM", sclSumry$model_run, value = TRUE)[1]
  initName <- grep("_init", sclSumry$model_run, value = TRUE)[1]
  termName <- grep(paste0("_", termYr), sclSumry$model_run, value = TRUE)[1]
  
  ggplot2::ggplot(data = sclSumry, #subset(sclSumry, model_run %in% c(omName, termName, initName)), 
                  ggplot2::aes(x = model_run, y = F_MSY)) +
              geom_point() +
              theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
              
  }

FmsyDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthselftest", termYr = 2024)
```

```{r Age1PlusDiagnosticPlot}
#SmryBio_ in ss_summary.sso? or outputSS[["timeseries"]]
# these aren't equal. SpawnBio matches between these files, but not outputSS[["timeseries"]]$Bio_smry

# outputSS[["timeseries"]] %>% select(Yr, Era, Seas, Bio_smry, `SmryBio_SX:1_GP:1`, SpawnBio)


# Function to plot OM and EM estimated Age1+ for sardine SS models
age1plusDiagPlots <- function(dir, # SSMSE directory (character)
                              scenario, # scenario name (character)
                              termYr # terminal year of MSE run
  ){

  # get the iterations
  iters <- list.dirs(file.path(dir, scenario), recursive = FALSE, full.names = FALSE)
  
  # # get the OM, init, and terminal year model directory names
  omName <- grep("_OM", list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)
  initName <- grep("_init", list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE), value = TRUE)
  
  termNames <- list.dirs(file.path(dir, scenario, iters[1]),
                                  recursive = FALSE,
                                  full.names = FALSE)
  termNames <- termNames[which(!termNames %in% c(omName, initName))]

  # Extract terminal summary biomass for OM and EM by iteration
  smryBio <- data.frame()
  for(i in iters){
    
    # RW: Don't need to pull from ss_summary file
    # emSummary <- readLines(con = file.path(dir, scenario, i, termName, "ss_summary.sso"), warn = FALSE)
    # 
    # emSummary[grep("#_Biomass", emSummary, fixed = TRUE):length(emSummary)]                   
    # emSummary[grepl("SmryBio_", emSummary, fixed = TRUE)]
    # 
    # 
    # get.vec <- function(dat, ind) {
    #   ## Returns the next vector of numbers in the dat vector.
    #   ## Increments ind in the parent environment.
    #   assign("ind", ind + 1, parent.frame())
    #   ## Split by whitespace and collapse (+).
    #   vec <- strsplit(dat[ind], "[[:blank:]]+")
    #   as.numeric(vec[[1]])
      
    initOutputSS <- SS_output(dir = file.path(dir, scenario, i, initName),
                          dir.mcmc = NULL,
                          repfile = "Report.sso",
                          compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
  
    # Get EM estimated Age1+
    smryEM <- initOutputSS[["sprseries"]] %>% select(Yr, Era, Bio_Smry.1) %>%
                  mutate(model_run = paste0(scenario, "_EM_term"),
                         iteration = as.integer(i))
    
    # Next get the forecast summary age 1+ biomass for each projected EM year
    for(y in max(smryEM$Yr):termYr){
      outputSS <- SS_output(dir = file.path(dir, scenario, i, 
                                            grep(y, termNames, value = TRUE)),
                          dir.mcmc = NULL,
                          repfile = "Report.sso",
                          compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
      
      nxtYrAge1Plus <- outputSS[["sprseries"]] %>% select(Yr, Era, Bio_Smry.1) %>%
                          mutate(model_run = paste0(scenario, "_EM_term"),
                                 iteration = as.integer(i)) %>%
                          filter(Yr == y+1)
      
      # add this to the EM time series
      smryEM <- rbind(smryEM, nxtYrAge1Plus)
    }
    
    OMoutputSS <- SS_output(dir = file.path(dir, scenario, i, omName),
                          dir.mcmc = NULL,
                          repfile = "Report.sso",
                          compfile = "CompReport.sso", verbose = FALSE, printstats = FALSE)
  
    # Get OM Age1+
    # 'sprseries' has the annual values, 'timeseries' has by season
    smryOM <- OMoutputSS[["sprseries"]] %>% select(Yr, Era, Bio_Smry.1) %>%
                  filter(Era == "TIME") %>% 
                  mutate(model_run = omName,
                         iteration = as.integer(i))
    
    smryBio <- rbind(smryBio, smryEM, smryOM)
    }
  
  absoluteSmry <- ggplot2::ggplot(data = smryBio, 
                  ggplot2::aes(x = Yr, y = Bio_Smry.1)) +
              ggplot2::geom_vline(xintercept = 2019, color = "gray") +
              ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = model_run))+
              ggplot2::scale_color_manual(values = c("#D65F00", "blue")) +
              ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
              ggplot2::guides(linetype = "none") +
              ggplot2::facet_wrap(. ~ iteration) +
              ggplot2::theme_classic()
  
  # Calculate Summary biomass relative error
  relSmry_EMtoOM <- smryBio %>% select(model_run, Yr, iteration, Bio_Smry.1) %>%
                      pivot_wider(id_cols = c(Yr, iteration),
                                  names_from = model_run, values_from = Bio_Smry.1) %>%
                      rename(OM = all_of(omName),
                             EM = all_of(paste0(scenario, "_EM_term"))) %>% 
                      mutate(errSmryBio = (EM - OM)/OM)
  
  relSmry <- ggplot(data = relSmry_EMtoOM, aes(x = Yr, y = errSmryBio)) +
    ggplot2::geom_vline(xintercept = 2019, color = "gray") +
    geom_hline(yintercept = 0, color = "black") +
    ggplot2::geom_line(ggplot2::aes(linetype = as.character(iteration), color = 2))+
    #ggplot2::scale_color_manual(values = c("#D65F00", "black", rep("blue", 5))) +
    ggplot2::scale_linetype_manual(values = rep("solid", 50)) +
    ggplot2::guides(linetype = "none") +
    ggplot2::facet_wrap(. ~ iteration) +
    ggplot2::theme_classic() +
    ylab("Relative Error (Summary Biomass)")
  
  list(absoluteSmry, relSmry)
}

age1plusDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
                  scenario = "cohortGrowthselftest", termYr = 2024)

```

## Self-test with acoustic-trawl and age and length comps specified in projection period

```{r OMself_wComps}
bDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
          scenario = "cohortGrowthself_compNsamp",
          termYr = 2024, surveyInx = 4)

compDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthself_compNsamp",
              termYr = 2024)

recrDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthself_compNsamp", termYr = 2024)

catchDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthself_compNsamp", termYr = 2024)

FmsyDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthself_compNsamp", termYr = 2024)

age1plusDiagPlots(dir = "C:/Users/rwildermuth/Documents/FutureSeas/SardineMSE/cohortGrowthOMandEM",
              scenario = "cohortGrowthself_compNsamp", termYr = 2024)

```
